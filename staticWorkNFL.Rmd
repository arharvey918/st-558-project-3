---
title: "NFL Data Analysis"
author: "Avy Harvey"
date: "7/21/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data

Data comes from data sets provided in ST 558, augmented with some additional calculated metrics. The games are filtered to include only regular season games.

```{r}
library(tidyverse)

scores <- read_csv("scoresFull.csv")

scores_df <- scores %>%
  filter(week %in% as.character(1:17)) %>%  # Regular season only
  mutate(day = as.factor(day)) %>%
  discard(is.character) %>%
  mutate(awayWin = (AFinal > HFinal),
         homeWin = (HFinal > AFinal),
         awayYPC = awayRushYds / awayRushAtt,
         homeYPC = homeRushYds / homeRushAtt,
         awayYPA = awayPassYds / awayPassAtt,
         homeYPA = homePassYds / homePassAtt,
         awayTPP = Aturnovers / AtotalPlays,
         homeTPP = Hturnovers / HtotalPlays,
         away3rdPct = away3rdConv / away3rdAtt,
         home3rdPct = home3rdConv / home3rdAtt,
         awayPenPerPlay = awayNumPen / AtotalPlays,
         homePenPerPlay = homeNumPen / HtotalPlays,
         homePlaysPerMinute = HtotalPlays / homeTOP,
         awayPlaysPerMinute = AtotalPlays / awayTOP,
         isFavoriteTheWinner = (homeSpread > 0 & homeWin) | (homeSpread < 0 & !homeWin),
         spread_diff = homeSpread - HminusAScore)
# Maybe add some differential metrics
```

## Data Exploration

### What is home-field advantage?

```{r}
scores_df %>%
  select(homeWin, season) %>%
  group_by(season, homeWin) %>%
  summarize(value = n()) %>%
  mutate(value = value / sum(value)) %>%
  filter(homeWin == TRUE) %>%
  ggplot(aes(x = season, y = value)) +
  #geom_bar(stat = "identity") +
  geom_line() +
  geom_point() +
  geom_hline(aes(yintercept = mean(value)), color = "blue", linetype = "dashed") +
  geom_smooth(method = lm, se = FALSE) +
  labs(x = "Season", y = "% of games won by home team", title = "Home Field Advantage by Season")
  # Text positioning: https://stackoverflow.com/a/12019601
  #  geom_text(aes(label=round(value, 3)), position=position_dodge(width=0.9), vjust=-0.25)

scores_df %>%
  select(homeWin, day) %>%
  group_by(day, homeWin) %>%
  summarize(value = n()) %>%
  mutate(value = value / sum(value))
```


### How does time of possession relate to margin of victory?

```{r}
ggplot(scores_df, aes(x = homeTOP, y = HminusAScore)) +
  geom_point(aes(color = season), alpha = 0.5) +
  geom_smooth(method = lm) +
  labs(title = "Score Differential vs. TOP", x = "TOP (Home)", y = "Score Differential (Home)")
```

### How often does the spread predict the winner?

```{r}
# Remove pick-em games
scores_df %>%
  filter(homeSpread != 0) %>%
  ggplot(aes(x = isFavoriteTheWinner)) +
  geom_bar(aes(y = stat(count / sum(count)), fill = homeWin)) # Proportion from https://ggplot2.tidyverse.org/reference/stat.html

scores_df %>%
  filter(homeSpread != 0) %>%
  select(season, isFavoriteTheWinner) %>%
  group_by(season) %>%
  summarize(vegasCorrectPct = sum(isFavoriteTheWinner) / n()) %>%
  ggplot(aes(x = season, y = vegasCorrectPct)) + 
  geom_line() +
  geom_point() +
  geom_hline(aes(yintercept = mean(vegasCorrectPct)), color = "blue", linetype="dashed") +
  labs(title = "Vegas Favorite Win % by Season", x = "Season", y = "Vegas Favorite Win %")
```

### How close is the spread to the actual point differential?

```{r}
# RMSE of predicted spread vs. actual
scores_df %>%
  group_by(season) %>%
  summarise(spread_rmse = sqrt(mean(spread_diff^2)))

# Histogram of predicted spread - actual
ggplot(scores_df, aes(x = spread_diff)) +
  geom_histogram(binwidth = 3, aes(y = stat(density)), alpha = 0.5) +
  geom_density(kernel = "gaussian", fill = "blue", alpha = 0.5, color = "blue") +
  # Referenced code: https://stackoverflow.com/a/13609916
  stat_function(fun = dnorm, args = list(mean = mean(scores_df$spread_diff), sd = sd(scores_df$spread_diff)), color = "orange") +
  geom_vline(aes(xintercept = mean(spread_diff)), linetype = "dashed") +
  labs(title = "Distribution of Vegas Spread Error", x = "Vegas Spread - Actual Spread", y = "Density")
```


### How does tempo relate to margin of victory?

Maybe total plays divided by TOP will reflect tempo?

```{r tempo-vs-margin-of-victory}
# Total plays
scores_df %>%
  ggplot(aes(x = HtotalPlays, y = HminusAScore)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Score Differential vs. Total Plays (Home)", x = "Total Plays", y = "Score Differential")

scores_df %>%
  ggplot(aes(x = AtotalPlays, y = -HminusAScore)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Score Differential vs. Total Plays (Away)", x = "Total Plays", y = "Score Differential")

# Plays per minute
scores_df %>%
  ggplot(aes(x = homePlaysPerMinute, y = HminusAScore)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Score Differential vs. Tempo (Home)", x = "Plays per Minute", y = "Score Differential")

scores_df %>%
  ggplot(aes(x = awayPlaysPerMinute, y = -HminusAScore)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Score Differential vs. Tempo (Away)", x = "Plays per Minute", y = "Score Differential")
```


### How do YAC and YPA relate to each other?

```{r}
scores_df %>%
  ggplot(aes(x = homeYPC, y = homeYPA, color = homeWin)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = lm)

scores_df %>%
  ggplot(aes(x = awayYPC, y = awayYPA, color = awayWin)) +
  geom_point(alpha = 0.3) +
  geom_smooth(method = lm)

scores_df %>%
  ggplot(aes(x = homeYPA, color = homeWin, fill = homeWin)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Yards per Passing Attempt (Home)", x = "Yards Per Attempt", y = "Density")

scores_df %>%
  ggplot(aes(x = awayYPA, color = awayWin, fill = awayWin)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Yards per Passing Attempt (Away)", x = "Yards Per Attempt", y = "Density")

scores_df %>%
  ggplot(aes(x = homeYPC, color = homeWin, fill = homeWin)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Yards per Carry (Home)", x = "Yards Per Carry", y = "Density")

scores_df %>%
  ggplot(aes(x = awayYPC, color = awayWin, fill = awayWin)) +
  geom_density(alpha = 0.5) +
  labs(title = "Distribution of Yards per Carry (Away)", x = "Yards Per Carry", y = "Density")
```

### Is there a relationship between season and rush/pass yards?

```{r}
scores_df %>%
  mutate(avgRushYds = (homeRushYds + awayRushYds) / 2,
         avgPassYds = (homePassYds + awayPassYds) / 2) %>%
  group_by(season) %>%
  summarize(avgRushYds = mean(avgRushYds), avgPassYds = mean(avgPassYds)) %>%
  pivot_longer(2:3, names_to = "type", values_to = "value") %>%
  ggplot(aes(x = season, y = value, fill = type)) +
  geom_bar(stat = "identity") +
  labs(title = "Average Yards Gained by Season", x = "Season", y = "Average Yards Gained")
```


## Unsupervised Learning

### PCA with biplot

TODO: determine which variables to allow for selection

```{r}
(principal_components <- prcomp(select(scores_df, homeTOP, homeYPC, homeYPA, awayYPC, awayYPA, HtotalPlays, AtotalPlays) , scale = TRUE))
biplot(principal_components, xlabs = rep(".", nrow(scores_df)), cex = 1.5)
```

## Supervised Learning

TODO: determine which variables to allow for selection

Allow test/train split modification?

What strategy/metrics will result in a win?

- Random Forest (mtry)
  - Allow option for cross validation
- Boosting (?)
  - Allow option for OOB estimates? Maybe just cross validation since that's what the others are.
- Logistic Regression (Lasso, penalty)
  - Allow option for cross validation

Can I beat the Vegas predictor with simple, pre-game metrics?
